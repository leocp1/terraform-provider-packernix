# Adding a new provider

## Internals

Each `packernix` [image resource](./website/docs/r/image.html.md) manages the
set of all images based on a fixed NixOS configuration built by the user on the
cloud provider (or in the region in cases like AWS where images are not
cross-region). Such a set is uniquely identified in the Terraform state by the
name of the Packer builder used and the ID of the newest image belonging to the
set. An overview of the internal CRUD operations follows:

- Create calls Packer on a base machine image to provision a passed NixOS
  configuration, and returns the singleton set containing the newly built image.
  This requires:
  - a base NixOS module that matches the hardware/disk layout of the base image.
  - a Packer template that applies an arbitrary NixOS configuration to the base
    image and labels the resulting image with the Nix store hash of the NixOS
    configuration.
- Read finds all images labelled with the Nix store hash.
- Update calls Read on the Packer template passed in the Terraform
  configuration. If the returned set is different from the set present in the
  Terraform state, Delete and re-Create.
- Delete deletes all images labelled with the specified Nix store hash.

Thus adding support for a new cloud provider requires the following:

1. A Packer builder plugin
2. A way to read/delete a set of images generated by the Packer builder plugin.
3. A base machine image
4. A base NixOS configuration whose hardware settings match those of the base
   machine image.
5. A way to generate Packer templates that provision an arbitrary NixOS
   configuration onto the base machine image and label the resulting image with
   the Nix store hash.

Steps to implement these dependencies are detailed in the following section.

## Steps to add new cloud providers

1. Write/find a [Packer builder](https://www.packer.io/docs/builders) plugin for
   the cloud provider.
2. Write the following
   [Packer plugins](https://www.packer.io/docs/extending/custom-builders):
   (Consider copying/importing the builder plugin from step 1, then modifying
   the `Build()` method.)
   - `packer-builder-read-${provider-name}` : Accept the same configuration as
     the `provider-name` builder. Find all images that could have been created
     by the user using a Packer template with the passed `builders` section.
     Return an
     [Artifact](https://godoc.org/github.com/hashicorp/packer/packer#Artifact)
     with
     - the `Id()` of the most recent such image if it exists
     - a `String()` equal to the number of images found
     - the same `BuilderId()` as the base builder
   - `packer-builder-delete-${provider-name}` : Same as the `read` plugin, but
     also delete the images found.
3. Find a base machine image on the cloud provider.
   - The image must
     - be publicly available
     - have Linux installed
     - have a superuser with `ssh` access
   - Sources for NixOS machine images include:
     - [NixOS Download](https://nixos.org/nixos/download.html)
     - [NixOS Wiki: NixOS Friendly Hosters](https://nixos.wiki/wiki/NixOS_friendly_hosters)
     - [`<nixpkgs/nixos/modules/virtualisation>`](https://github.com/NixOS/nixpkgs/tree/master/nixos/modules/virtualisation)
       - [`azure-images.nix`](https://github.com/NixOS/nixpkgs/tree/master/nixos/modules/virtualisation/azure-images.nix)
       - [`ec2-amis.nix`](https://github.com/NixOS/nixpkgs/tree/master/nixos/modules/virtualisation/ec2-amis.nix)
       - [`gce-images.nix`](https://github.com/NixOS/nixpkgs/tree/master/nixos/modules/virtualisation/gce-images.nix)
4. Write/find a NixOS configuration module for other configurations that use the
   same base machine image. The goal should be the minimum configuration
   (measured in lines of Nix code) that keeps the provisioning user's `ssh`
   access, so Packer can function after the switch to the NixOS configuration.
   - Some sources for existing configuration modules include:
     - [nixos-hardware](https://github.com/NixOS/nixos-hardware)
     - [nixos-generators](https://github.com/nix-community/nixos-generators).
     - [`<nixpkgs/nixos/maintainers/scripts>`](https://github.com/NixOS/nixpkgs/tree/master/nixos/maintainers/scripts)
     - [`<nixpkgs/nixos/modules/virtualisation>`](https://github.com/NixOS/nixpkgs/tree/master/nixos/modules/virtualisation)
       (look for `*-config.nix` and `amazon-image.nix`)
   - If there is no preexisting module, a good starting point is to
     - Run `nixos-generate-config` on the base image and copy
       `hardware-configuration.nix`.
     - Add the provisioning user.
     - Enable `ssh` for the provisioning user.
     - Change the `fileSystems` to mount disks based off of labels, and have the
       root partition's disk have the label `nixos`.
     - Set the boot loader.
   - Prefer setting options with `lib.mkDefault` so users can override the
     module with their own settings.
   - The naming scheme used for the configuration files is
     `${Packer builder plugin name}-config.nix`
5. Write a Nix function to generate a Packer template that provisions the NixOS
   configuration from step 4 onto the base machine image.
   - Requirements:
     - The function must require only one argument: `nixos`, a string which has
       the Nix store path of the NixOS configuration.
     - The name of the Nix file should be `${Packer builder plugin name}.nix`.
     - The function must output a valid Packer template when evaluated with
       `nix-instantiate --eval --json --argstr nixos $NIXOS_STORE_PATH "${builder name}.nix"`.
     - A name, label, or description field of the image must contain the hash of
       the Nix store path.
   - Recommendations:
     - Consider using the preexisting [scripts](./packer/scripts) and
       [library](./packer/lib.nix) functions. The Nix expression should not
       import paths outside of the [`packer`](./packer) directory.
     - Consider using the
       [packer-provisioner-fakessh](https://github.com/leocp1/packer-provisioner-fakessh)
       plugin to run `nix-copy-closure`.
     - Consider implementing the "common arguments" listed in the
       [`packernix` documentation](./website/docs/r/image.html.md#using-the-bundled-templates).
     - The root partition should have label `"nixos"`.
6. (Optional) Add to `packernix`.
   - Add the plugins from steps 1 and 2 to the
     [overlay](./pkgs/development/tools/packer-plugins/default.nix).
   - Add the module written in step 4 to [`nixos/modules`](./nixos/modules).
   - Add the template written in step 5 to [`packer`](./packer).
   - Add a NixOS configuration named `${Packer builder plugin name}.nix` to the
     [OS test data](./src/pkg/provider/testdata/os/). This configuration should
     generally just import the module written in step 4.
   - Edit the `ps` slice in the
     [`TestAccResourceImage` test](./src/pkg/provider/resource_image_test.go) to
     contain your builder.
